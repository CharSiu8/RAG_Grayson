<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAYSON - AI Research Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator span { animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .markdown-content a { color: #3b82f6; text-decoration: underline; }
        .markdown-content strong { font-weight: 600; }

        /* Dark mode styles */
        .dark { background-color: #0d0d0d; color: #ffffff; }
        .dark .bg-white { background-color: #1a1a1a; }
        .dark .bg-gray-50 { background-color: #0d0d0d; }
        .dark .border-gray-200 { border-color: #333333; }
        .dark .border-gray-300 { border-color: #444444; }
        .dark .text-gray-900 { color: #ffffff; }
        .dark .text-gray-500 { color: #b0b0b0; }
        .dark .text-gray-600 { color: #a0a0a0; }
        .dark .bg-blue-50 { background-color: #1a1a1a; }
        .dark .border-blue-100 { border-color: #333333; }
        .dark .text-blue-800 { color: #60a5fa; }
        .dark .border-blue-200 { border-color: #444444; }
        .dark .text-blue-700 { color: #60a5fa; }
        .dark .text-blue-600 { color: #60a5fa; }
        .dark .border-gray-100 { border-color: #333333; }
        .dark .markdown-content a { color: #60a5fa; }
        .dark input { background-color: #1a1a1a; color: #ffffff; border-color: #444444; }
        .dark input::placeholder { color: #888888; }
        .dark .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .dark .hover\:bg-gray-100:hover { background-color: #2a2a2a; }
        .dark .hover\:bg-blue-100:hover { background-color: #2a2a2a; }
        .dark .bg-blue-600 { background-color: #2563eb; }
        .dark .text-white { color: #ffffff; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="flex flex-col h-screen max-w-4xl mx-auto">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
                <span class="text-white font-bold text-lg">G</span>
            </div>
            <div class="flex-1">
                <h1 class="text-xl font-semibold text-gray-900">GRAYSON</h1>
                <p class="text-sm text-gray-500">Theological PhD level Research Assistant</p>
            </div>
            <!-- Dark Mode Toggle -->
            <button id="theme-toggle" class="p-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition" title="Toggle dark mode">
                <svg id="sun-icon" class="w-5 h-5 text-gray-600 hidden" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                </svg>
                <svg id="moon-icon" class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                </svg>
            </button>
        </header>

        <!-- Messages -->
        <main id="messages" class="flex-1 overflow-y-auto p-6 space-y-4">
            <div class="text-center text-gray-500 py-8">
                <p class="text-lg mb-2">Welcome to GRAYSON</p>
                <p class="text-sm">Hello, I am programmed to research theological concepts and their relationships to biblical texts. While I am able to search multiple libraries, I specialize in providing OMNI, JSTOR, and free PDF resources.</p>
            </div>
        </main>

        <!-- Library Links (shown after query) -->
        <div id="library-links" class="hidden px-6 py-3 bg-blue-50 border-t border-blue-100">
            <p class="text-sm text-blue-800 mb-2 font-medium">Search in academic databases:</p>
            <div class="flex gap-3">
                <a id="omni-link" href="#" target="_blank" class="px-4 py-2 bg-white border border-blue-200 rounded-lg text-sm text-blue-700 hover:bg-blue-100 transition">
                    OMNI Library
                </a>
                <a id="jstor-link" href="#" target="_blank" class="px-4 py-2 bg-white border border-blue-200 rounded-lg text-sm text-blue-700 hover:bg-blue-100 transition">
                    JSTOR
                </a>
            </div>
        </div>

        <!-- Input -->
        <div class="bg-white border-t border-gray-200 p-4">
            <form id="chat-form" class="flex gap-3">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Ask about any research topic..."
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    autocomplete="off"
                >
                <button
                    type="submit"
                    id="send-btn"
                    class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const messagesContainer = document.getElementById('messages');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const libraryLinks = document.getElementById('library-links');
        const omniLink = document.getElementById('omni-link');
        const jstorLink = document.getElementById('jstor-link');

        let isLoading = false;

        function addMessage(content, isUser = false, sources = []) {
            const div = document.createElement('div');
            div.className = `message-enter ${isUser ? 'flex justify-end' : ''}`;

            const bubble = document.createElement('div');
            bubble.className = isUser
                ? 'bg-blue-600 text-white px-4 py-3 rounded-2xl rounded-br-md max-w-[80%]'
                : 'bg-white border border-gray-200 px-4 py-3 rounded-2xl rounded-bl-md max-w-[90%] shadow-sm';

            // Parse markdown-like formatting
            const formattedContent = content
                .replace(/\*\*Have you considered\?\*\*/g, '<strong class="text-blue-600">Have you considered?</strong>')
                .replace(/\*\*Sources:\*\*/g, '<strong>Sources:</strong>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\[(.*?)\]\((.*?)\)/g, (match, text, url) => {
                    // Only create clickable links for valid URLs starting with http
                    if (url && url.startsWith('http')) {
                        return `<a href="${url}" target="_blank">${text}</a>`;
                    }
                    return text; // Just show text if URL is invalid
                })
                .replace(/\n/g, '<br>');

            bubble.innerHTML = `<div class="markdown-content">${formattedContent}</div>`;

            // Add sources if present
            if (sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'mt-3 pt-3 border-t border-gray-100';
                sourcesDiv.innerHTML = `
                    <p class="text-xs text-gray-500 mb-2">Sources:</p>
                    ${sources.map(s => `
                        <div class="flex items-center gap-2 mb-1">
                            <a href="${s.doi || s.url || '#'}" target="_blank" class="text-sm text-blue-600 hover:underline truncate flex-1">
                                ${s.title || 'Untitled'} ${s.year ? `(${s.year})` : ''}
                            </a>
                            ${s.free_pdf ? `<a href="${s.free_pdf}" target="_blank" class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded hover:bg-green-200 transition whitespace-nowrap">Free PDF</a>` : ''}
                        </div>
                    `).join('')}
                `;
                bubble.appendChild(sourcesDiv);
            }

            div.appendChild(bubble);
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addLoadingIndicator() {
            const div = document.createElement('div');
            div.id = 'loading-indicator';
            div.className = 'message-enter';
            div.innerHTML = `
                <div class="bg-white border border-gray-200 px-4 py-3 rounded-2xl rounded-bl-md shadow-sm inline-block">
                    <div class="typing-indicator flex gap-1">
                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.remove();
        }

        function updateLibraryLinks(links) {
            if (links && links.omni && links.jstor) {
                omniLink.href = links.omni;
                jstorLink.href = links.jstor;
                libraryLinks.classList.remove('hidden');
            }
        }

        function addFeedbackHint() {
            const div = document.createElement('div');
            div.className = 'message-enter text-center py-2';
            div.innerHTML = `
                <p class="text-xs text-gray-400">Type <span class="font-mono bg-gray-100 dark:bg-gray-800 px-1 rounded">/feedback</span> followed by your message to send feedback to the devs</p>
            `;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendFeedback(message) {
            isLoading = true;
            sendBtn.disabled = true;
            input.disabled = true;

            addMessage(message, true);
            addLoadingIndicator();

            try {
                const response = await fetch(`${API_URL}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                removeLoadingIndicator();

                if (response.ok) {
                    addMessage('Thank you for your feedback! Your message has been sent to the developers.', false);
                } else {
                    const data = await response.json();
                    addMessage(`Failed to send feedback: ${data.detail || 'Unknown error'}`, false);
                }
            } catch (error) {
                removeLoadingIndicator();
                addMessage('Sorry, failed to send feedback. Please try again later.', false);
                console.error('Error:', error);
            }

            isLoading = false;
            sendBtn.disabled = false;
            input.disabled = false;
            input.focus();
        }

        async function sendMessage(message) {
            if (isLoading || !message.trim()) return;

            isLoading = true;
            sendBtn.disabled = true;
            input.disabled = true;

            // Clear welcome message on first query
            if (messagesContainer.querySelector('.text-center')) {
                messagesContainer.innerHTML = '';
            }

            addMessage(message, true);
            addLoadingIndicator();

            try {
                const response = await fetch(`${API_URL}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: message, top_k: 5 })
                });

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                removeLoadingIndicator();
                addMessage(data.answer, false, data.sources || []);
                updateLibraryLinks(data.library_links);
                addFeedbackHint();

            } catch (error) {
                removeLoadingIndicator();
                addMessage('Sorry, I encountered an error connecting to the server. Make sure the backend is running on localhost:8000.', false);
                console.error('Error:', error);
            }

            isLoading = false;
            sendBtn.disabled = false;
            input.disabled = false;
            input.focus();
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = input.value.trim();
            if (message) {
                // Check for /feedback command
                if (message.toLowerCase().startsWith('/feedback')) {
                    const feedbackText = message.slice(9).trim(); // Remove "/feedback" prefix
                    if (feedbackText) {
                        sendFeedback(feedbackText);
                    } else {
                        addMessage('/feedback', true);
                        addMessage('Please include a message with your feedback. Example: /feedback The search results are great!', false);
                    }
                } else {
                    sendMessage(message);
                }
                input.value = '';
            }
        });

        // Focus input on load
        input.focus();

        // Dark mode toggle
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const body = document.body;

        // Check for saved preference or system preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                body.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }

        function toggleTheme() {
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            sunIcon.classList.toggle('hidden', !isDark);
            moonIcon.classList.toggle('hidden', isDark);
        }

        themeToggle.addEventListener('click', toggleTheme);
        initTheme();
    </script>
</body>
</html>
